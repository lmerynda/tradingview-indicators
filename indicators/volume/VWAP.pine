// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© TradingView Indicators

//@version=5
indicator("Volume Weighted Average Price (VWAP)", shorttitle="VWAP", overlay=true)

// Inputs
anchorPeriod = input.string("Session", title="Anchor Period", options=["Session", "Week", "Month"])
src = input.source(hlc3, title="Source")
showBands = input.bool(true, title="Show Standard Deviation Bands")
mult1 = input.float(1.0, minval=0.1, title="1st Band Multiplier")
mult2 = input.float(2.0, minval=0.1, title="2nd Band Multiplier")

// VWAP Calculation
var float sumSrcVol = 0.0
var float sumVol = 0.0
var float vwap = na

// Reset on new period
isNewPeriod = switch anchorPeriod
    "Session" => ta.change(time("D"))
    "Week" => ta.change(time("W"))
    "Month" => ta.change(time("M"))
    => ta.change(time("D"))

if isNewPeriod
    sumSrcVol := 0.0
    sumVol := 0.0

sumSrcVol += src * volume
sumVol += volume
vwap := sumSrcVol / sumVol

// Standard Deviation Calculation
var float sumSqDiff = 0.0
if isNewPeriod
    sumSqDiff := 0.0

sumSqDiff += math.pow(src - vwap, 2) * volume
variance = sumSqDiff / sumVol
stdDev = math.sqrt(variance)

// Bands
upperBand1 = vwap + mult1 * stdDev
lowerBand1 = vwap - mult1 * stdDev
upperBand2 = vwap + mult2 * stdDev
lowerBand2 = vwap - mult2 * stdDev

// Plot
plot(vwap, title="VWAP", color=color.blue, linewidth=2)
plot(showBands ? upperBand1 : na, title="Upper Band 1", color=color.new(color.green, 50), linewidth=1)
plot(showBands ? lowerBand1 : na, title="Lower Band 1", color=color.new(color.red, 50), linewidth=1)
plot(showBands ? upperBand2 : na, title="Upper Band 2", color=color.new(color.green, 70), linewidth=1)
plot(showBands ? lowerBand2 : na, title="Lower Band 2", color=color.new(color.red, 70), linewidth=1)

// Alert conditions
alertcondition(ta.cross(close, vwap), title="Price Crosses VWAP", message="Price crossed VWAP")
