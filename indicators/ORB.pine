// Opening Range (ORB) — 30s & 30min
// Marks the session opening range for the first 30 seconds and first 30 minutes.
// Standalone indicator following repository naming convention.

//@version=6
indicator("Opening Range (ORB) — 30s & 30min", shorttitle="ORB", overlay=true)



// Inputs
show30s = input.bool(true, title="Show 30s Opening Range")
show30m = input.bool(true, title="Show 30min Opening Range")

// Timezone for session windows
useNewYorkTz = input.bool(false, title="Use New York time (ET) for sessions")
sessTz = useNewYorkTz ? "America/New_York" : syminfo.timezone

// Session windows (times are interpreted in `sessTz`)
asiaSession = input.session("1700-0159", title="Asia Session (in session timezone)")
europeSession = input.session("0200-0829", title="Europe Session (in session timezone)")
usSession = input.session("0830-1559", title="US Session (in session timezone)")

// Style inputs
// Security fallbacks (use lower/higher timeframe data when chart TF is coarser)
useSecurity30s = input.bool(true, title="Use 30s security fallback (for coarse charts)")
useSecurity30m = input.bool(true, title="Use 30min security fallback (for coarse charts)")

// Visual styling
orLineColor = input.color(color.rgb(255,215,0), title="OR Line Color")
orLabelBg = input.color(color.rgb(255,215,0), title="OR Label Background Color")
orLabelText = input.color(color.black, title="OR Label Text Color")

// Label style input
labelSizeInput = input.string("large", title="Label Size", options=["tiny","small","normal","large"])
lblSize = size.large
if labelSizeInput == "tiny"
    lblSize := size.tiny
else if labelSizeInput == "small"
    lblSize := size.small
else if labelSizeInput == "normal"
    lblSize := size.normal
else if labelSizeInput == "large"
    lblSize := size.large
else
    lblSize := size.large

// Session detection (start on the first bar that enters each session window).
asiaT = time(timeframe.period, asiaSession, sessTz)
europeT = time(timeframe.period, europeSession, sessTz)
usT = time(timeframe.period, usSession, sessTz)

inAsia = not na(asiaT)
inEurope = not na(europeT)
inUS = not na(usT)

asiaStart = not na(asiaT) and na(asiaT[1])
europeStart = not na(europeT) and na(europeT[1])
usStart = not na(usT) and na(usT[1])

newSession = asiaStart or europeStart or usStart

var int activeSessionStart = na
var string activeSessionName = na

// We anchor lines using absolute timestamps (`xloc.bar_time`), so a bar_index anchor is not required.
var int activeSessionBar = na

// Opening range end timestamps (ms) (use active session)
or30s_end = not na(activeSessionStart) ? activeSessionStart + 30 * 1000 : na
or30m_end = not na(activeSessionStart) ? activeSessionStart + 30 * 60 * 1000 : na

// OR variables
var float or30s_high = na
var float or30s_low = na
var float or30m_high = na
var float or30m_low = na

// Object handles
var line h30s = na
var line l30s = na
var line h30m = na
var line l30m = na
var label lab30s_h = na
var label lab30s_l = na
var label lab30m_h = na
var label lab30m_l = na
// On new session start: set the anchor, and delete prior session OR levels so only the current session remains.
if newSession
    activeSessionStart := time
    activeSessionName := asiaStart ? "Asia" : europeStart ? "Europe" : "US"
    activeSessionBar := bar_index

    or30s_high := na
    or30s_low := na
    or30m_high := na
    or30m_low := na

    if not na(h30s)
        line.delete(h30s)
        h30s := na
    if not na(l30s)
        line.delete(l30s)
        l30s := na
    if not na(h30m)
        line.delete(h30m)
        h30m := na
    if not na(l30m)
        line.delete(l30m)
        l30m := na
    if not na(lab30s_h)
        label.delete(lab30s_h)
        lab30s_h := na
    if not na(lab30s_l)
        label.delete(lab30s_l)
        lab30s_l := na
    if not na(lab30m_h)
        label.delete(lab30m_h)
        lab30m_h := na
    if not na(lab30m_l)
        label.delete(lab30m_l)
        lab30m_l := na

    log.info("ORB session start: name={0}, start={1}, tz={2}", activeSessionName, activeSessionStart, sessTz)

// Update high/low during the OR periods
if show30s
    if useSecurity30s
        [h30s_s, l30s_s, t30s_s] = request.security(syminfo.tickerid, "30S", [high, low, time], gaps=barmerge.gaps_off)
        if not na(t30s_s) and not na(activeSessionStart) and t30s_s >= activeSessionStart and t30s_s <= or30s_end
            or30s_high := nz(or30s_high, h30s_s)
            or30s_high := math.max(or30s_high, h30s_s)
            or30s_low := nz(or30s_low, l30s_s)
            or30s_low := math.min(or30s_low, l30s_s)
    else
        if not na(activeSessionStart) and time >= activeSessionStart and time <= or30s_end
            or30s_high := nz(or30s_high, high)
            or30s_high := math.max(or30s_high, high)
            or30s_low := nz(or30s_low, low)
            or30s_low := math.min(or30s_low, low)

if show30m
    if useSecurity30m
        [h30m_s, l30m_s, t30m_s] = request.security(syminfo.tickerid, "30", [high, low, time], gaps=barmerge.gaps_off)
        if not na(t30m_s) and not na(activeSessionStart) and t30m_s >= activeSessionStart and t30m_s <= or30m_end
            or30m_high := nz(or30m_high, h30m_s)
            or30m_high := math.max(or30m_high, h30m_s)
            or30m_low := nz(or30m_low, l30m_s)
            or30m_low := math.min(or30m_low, l30m_s)
    else
        if not na(activeSessionStart) and time >= activeSessionStart and time <= or30m_end
            or30m_high := nz(or30m_high, high)
            or30m_high := math.max(or30m_high, high)
            or30m_low := nz(or30m_low, low)
            or30m_low := math.min(or30m_low, low)

// When OR completes, draw box and boundary lines (create once per session)
// When OR completes, draw lines and labels
if show30s and time > or30s_end and not na(or30s_high) and na(h30s)
    // draw horizontal lines extended to the right (gold)
    if not na(activeSessionStart)
        h30s := line.new(x1=activeSessionStart, y1=or30s_high, x2=time, y2=or30s_high, xloc=xloc.bar_time, extend=extend.right, color=orLineColor, width=2)
        l30s := line.new(x1=activeSessionStart, y1=or30s_low, x2=time, y2=or30s_low, xloc=xloc.bar_time, extend=extend.right, color=orLineColor, width=2)
    // right-aligned labels centered on the line
    lab30s_h := label.new(x=bar_index, y=or30s_high, text=str.format("30s H: {0}", str.tostring(or30s_high, format.mintick)), xloc=xloc.bar_index, yloc=yloc.price, style=label.style_label_right, color=orLabelBg, textcolor=orLabelText, size=lblSize)
    lab30s_l := label.new(x=bar_index, y=or30s_low, text=str.format("30s L: {0}", str.tostring(or30s_low, format.mintick)), xloc=xloc.bar_index, yloc=yloc.price, style=label.style_label_right, color=orLabelBg, textcolor=orLabelText, size=lblSize)
    log.info("ORB event: 30s OR created: session={0}, start={1}, H={2}, L={3}", activeSessionName, activeSessionStart, or30s_high, or30s_low)

if show30m and time > or30m_end and not na(or30m_high) and na(h30m)
    if not na(activeSessionStart)
        h30m := line.new(x1=activeSessionStart, y1=or30m_high, x2=time, y2=or30m_high, xloc=xloc.bar_time, extend=extend.right, color=orLineColor, width=2)
        l30m := line.new(x1=activeSessionStart, y1=or30m_low, x2=time, y2=or30m_low, xloc=xloc.bar_time, extend=extend.right, color=orLineColor, width=2)
    lab30m_h := label.new(x=bar_index, y=or30m_high, text=str.format("30m H: {0}", str.tostring(or30m_high, format.mintick)), xloc=xloc.bar_index, yloc=yloc.price, style=label.style_label_right, color=orLabelBg, textcolor=orLabelText, size=lblSize)
    lab30m_l := label.new(x=bar_index, y=or30m_low, text=str.format("30m L: {0}", str.tostring(or30m_low, format.mintick)), xloc=xloc.bar_index, yloc=yloc.price, style=label.style_label_right, color=orLabelBg, textcolor=orLabelText, size=lblSize)
    log.info("ORB event: 30m OR created: session={0}, start={1}, H={2}, L={3}", activeSessionName, activeSessionStart, or30m_high, or30m_low)

// Keep labels right-aligned on the latest bar.
if not na(lab30s_h)
    label.set_x(lab30s_h, bar_index)
    label.set_y(lab30s_h, or30s_high)
if not na(lab30s_l)
    label.set_x(lab30s_l, bar_index)
    label.set_y(lab30s_l, or30s_low)
if not na(lab30m_h)
    label.set_x(lab30m_h, bar_index)
    label.set_y(lab30m_h, or30m_high)
if not na(lab30m_l)
    label.set_x(lab30m_l, bar_index)
    label.set_y(lab30m_l, or30m_low)

// Labels are created when the OR lines are drawn (right-aligned on the line)

// Notes: These opening ranges are calculated relative to the chart's session (trading day).
// If your chart timeframe is larger than the OR period (for example a 1-minute chart vs 30s OR),
// the OR will reflect the first bar(s) available and may not precisely represent sub-bar activity.

// Logs are emitted on session start and OR creation.
